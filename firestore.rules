rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // 用戶文檔規則
    match /users/{userId} {
      // 所有登入用戶都可以讀取（用於查找和顯示成員）
      allow read: if request.auth != null;

      // 只有用戶本人可以寫入自己的資料
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // 旅程規則
    match /trips/{tripId} {
      // 讀取：只有旅程成員可以讀取
      allow read: if request.auth != null &&
        request.auth.uid in resource.data.members;

      // 創建：任何登入用戶都可以創建旅程
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.createdBy &&
        request.auth.uid in request.resource.data.members;

      // 更新：創建者可以完全更新，成員可以編輯部分資料
      allow update: if request.auth != null &&
        (request.auth.uid == resource.data.createdBy ||
         (request.auth.uid in resource.data.members &&
          request.resource.data.members == resource.data.members &&
          request.resource.data.createdBy == resource.data.createdBy));

      // 刪除：只有創建者可以刪除
      allow delete: if request.auth != null &&
        request.auth.uid == resource.data.createdBy;
    }

    // 景點規則
    match /places/{placeId} {
      // 讀取：所有登入用戶都可以讀取
      allow read: if request.auth != null;

      // 創建：任何登入用戶都可以創建景點
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.addedBy;

      // 更新和刪除：景點創建者或旅程成員可以操作
      allow update, delete: if request.auth != null &&
        (request.auth.uid == resource.data.addedBy ||
         request.auth.uid in get(/databases/$(database)/documents/trips/$(resource.data.tripId)).data.members);
    }

    // 行程規則
    match /itineraries/{itineraryId} {
      // 所有登入用戶都可以讀寫行程
      allow read, write: if request.auth != null;
    }
  }
}
